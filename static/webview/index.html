<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Add bootstrap stylesheet -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous" />
</head>

<body class="container bg-transparent text-white">
    <h1 class="d-flex justify-content-center py-2">Add Update Project</h1>
    <p class="d-flex justify-content-center fst-italic">Update field is pre populated with last commit message from local git history</p>
    <!-- Markdown Editor and Preview -->
    <div class="d-flex justify-content-between">
        <textarea class="px-2 py-1 rounded" style="width: 47%" id="update-input" rows="20"></textarea>
        <p class="px-2 py-1 rounded bg-light h-auto m-0 overflow-auto text-black" style="width: 47%" id="update-preview"></p>
    </div>

    <!-- Button to refresh projects -->
    <div class="d-flex justify-content-center w-100 pt-4">
        <button type="button" class="btn btn-primary" id="submit-update" onclick="handleSubmitUpdateClick()">
        Submit Update
      </button>
    </div>
    <script src=" https://cdn.jsdelivr.net/npm/showdown@2.1.0/dist/showdown.min.js "></script>
    <script>
        // Import the API, Keyring and some utility functions
        const vscode = acquireVsCodeApi();
        var converter = new showdown.Converter();
        let projectId = "";
        let lastCommitMessage = "";

        window.onload = () => {
            console.log("Loading")
                // Set the value of the input field
            const updateInput = document.getElementById("update-input");
            updateInput.value = lastCommitMessage;
            // Get focus on the input field
            document.getElementById("update-input").focus();
        };

        // Handle textarea input change
        window.addEventListener("input", (event) => {
            const target = event.target;
            const id = target.id;
            const value = target.value;

            switch (id) {
                case "update-input":
                    // Get the value of markdown input
                    const markdownInput = document.getElementById("update-input");
                    var html = converter.makeHtml(markdownInput.value);
                    document.getElementById("update-preview").innerHTML = html;
                    break;
                default:
                    break;
            }
        });

        const handleSubmitUpdateClick = () => {
            // Get the value of update input
            const updateInput = document.getElementById("update-input");
            const updateContent = updateInput.value;

            const json = JSON.stringify({
                updateContent: JSON.stringify(updateContent),
                projectId: projectId,
            });

            // Send the update value to the extension
            vscode.postMessage({
                command: "submitUpdate",
                data: json,
            });
        };

        // Handle message posted from the extension
        window.addEventListener("message", (event) => {
            const eventData = event.data;
            const command = eventData.command;
            const data = eventData.data;

            switch (command) {
                case "setWebViewProject":
                    // Update the project id
                    const parsedData = JSON.parse(data);
                    projectId = parsedData.projectId;
                    lastCommitMessage = parsedData.lastCommitMessage;
                    // Set the value of the input field
                    const updateInput = document.getElementById("update-input");
                    updateInput.value = lastCommitMessage;
                    break;
                default:
                    break;
            }
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js " integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4 " crossorigin="anonymous "></script>
</body>

</html>